# Implementing Light & Dark Mode in a Next.js App with TailwindCSS

_Updated on: June 14, 2024 by Joy_
_Estimated reading time: 6 minutes_

Setting up light and dark mode themes using TailwindCSS is straightforward. However, allowing users to toggle between these themes while respecting their system preferences and avoiding page flicker presents a challenge.

## The Challenge

Next.js generates static pages on the server before delivering them to the client. This process speeds up the site but does not allow the server to detect user preferences. Therefore, the server cannot determine if a user prefers light or dark mode in their browser settings.

A viable approach is to use TailwindCSS's dark mode variant, which applies the user's `prefers-color-scheme` setting automatically.

To enable users to toggle between light and dark mode, it is necessary to read their system preference and store any changes made in localStorage. Since localStorage is only accessible in the browser, server components can't read it, leading to potential theme flashes during load due to incorrect initial themes.

Fortunately, the `next-themes` package can address this issue while enabling user toggles for a Next.js site.

# Todos for Dark/Light Theme Toggle Implementation:

1. Avoid React Context in Server Components:

   - React context is not supported in Server Components. Attempting to create a context at the root of the application will cause an error.

2. Create Context in a Client Component:

   - Create the context and its provider within a Client Component to ensure compatibility.

3. Render Provider from Server Component:

   - Mark the Client Component (with the context provider) to be rendered directly by the Server Component. This enables the Server Component to render the provider without errors.

4. Ensure Context Availability:

   - By rendering the context provider at the root level, ensure that all other Client Components throughout the app can consume this context for the dark/light theme toggle functionality.

5. Suppress Hydration Warning:

   - **Objective:** Avoid warnings about server and client rendering different content during server-side rendering.
   - **Action:** Set suppressHydrationWarning to true.
   - **Note:** This option works only one level deep and is intended to be used as an escape hatch.

6. Set Up TailwindCSS:

   - Ensure `tailwind.config.ts` includes `darkMode: 'class'` to enable manual toggling of dark mode.

7. Use next-themes:

   - Install and configure `next-themes` to handle theme toggling and system preference detection seamlessly.

8. Implement a Theme Switch:

   - Create a `ThemeSwitch` component that allows users to toggle between light and dark modes using icons.

## Implementation Steps

1. **Configure TailwindCSS**

   To allow manual toggling of dark mode, add a `darkMode` setting with a `class` value in the TailwindCSS config file.

   ```js
   // tailwind.config.ts
   /** @type {import('tailwindcss').Config} */
   module.exports = {
   	darkMode: 'class'
   	// other configurations
   };
   ```

2. Install next-themes

Run the following command to add next-themes to the project:

bun install next-themes

or

pnpm install next-themes

3. Create a Theme Provider

Create a providers.tsx file inside the app directory:

```js
'use client';

import { ThemeProvider } from 'next-themes';

interface NextThemeProviderProps {
	children: React.ReactNode;
}

const NextThemeProvider = ({ children }: NextThemeProviderProps) => {
	return (
		<ThemeProvider
			attribute='class'
			defaultTheme='system'
			enableSystem
		>
			{children}
		</ThemeProvider>
	);
};

export default NextThemeProvider;
```

4. Wrap Your Application with the Provider

Add the Providers component to the root layout.tsx:

```js
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import ThemeWrapper from '../providers/ThemeWrapper';
import './globals.css';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
	title: 'Create Next App',
	description: 'Generated by create next app'
};

export default function RootLayout({
	children
}: Readonly<{
	children: React.ReactNode
}>) {
	return (
		<html lang='en' suppressHydrationWarning>
			<body className={inter.className}>
				<ThemeWrapper>
					<main>{children}</main>
				</ThemeWrapper>
			</body>
		</html>
	);
}
```

The suppressHydrationWarning attribute is used to prevent warnings caused by the html element being updated by next-themes.

5. Create the Theme Switch Component

- Implement a component to let users switch themes:

```js
// app/_components/ThemeSwitch.tsx
'use client';

import { useTheme } from 'next-themes';
import Image from 'next/image';
import { useEffect, useState } from 'react';
import { FiMoon, FiSun } from 'react-icons/fi';

const ThemeSwitch = () => {
	const [mounted, setMounted] = useState(false);
	const { setTheme, resolvedTheme } = useTheme();

	useEffect(() => setMounted(true), []);

	if (!mounted) {
		return (
			<Image
				src='data:image/svg+xml;base64,PHN2ZyBzdHJva2U9IiNGRkZGRkYiIGZpbGw9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMCIgdmlld0JveD0iMCAwIDI0IDI0IiBoZWlnaHQ9IjIwMHB4IiB3aWR0aD0iMjAwcHgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB4PSIyIiB5PSIyIiBmaWxsPSJub25lIiBzdHJva2Utd2lkdGg9IjIiIHJ4PSIyIj48L3JlY3Q+PC9zdmc+Cg=='
				width={36}
				height={36}
				alt='Loading Light/Dark Toggle'
				priority={false}
				title='Loading Light/Dark Toggle'
				className='opacity-0'
			/>
		);
	}

	return (
		<div
			className='cursor-pointer'
			onClick={() =>
				setTheme(resolvedTheme === 'dark' ? 'light' : 'dark')
			}
			title={`Switch to ${
				resolvedTheme === 'dark' ? 'light' : 'dark'
			} mode`}
		>
			{resolvedTheme === 'dark' ? (
				<FiSun className='text-yellow-500 hover:text-yellow-600' />
			) : (
				<FiMoon className='text-blue-700 hover:text-blue-900' />
			)}
		</div>
	);
};

export default ThemeSwitch;
```

The aim here is to enable users to click an icon to change the theme. If the sun icon is clicked in dark mode, it switches to light mode, and vice versa.

# Final Outcome

By following these steps, a Next.js app will respect user system preferences for light and dark modes while allowing users to toggle the theme manually. The next-themes package handles saving the theme choice in localStorage, avoiding page flash during theme change. Although a flash might still be experienced in development mode, in production, the site should load seamlessly with the correct theme.
